#!/usr/bin/env python3
"""
CLI tool to index a codebase for semantic search.

Usage:
    code-index <path> [--force]
    code-index .                  # Index current directory
    code-index ~/projects/myapp   # Index specific project
    code-index . --force          # Force re-index everything
"""
import sys
import os
from pathlib import Path

# Add the package to path (works with symlinks)
SCRIPT_DIR = Path(__file__).resolve().parent
PACKAGE_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(PACKAGE_DIR))

# Ensure we're using the venv if not already activated
VENV_PYTHON = PACKAGE_DIR / "venv" / "bin" / "python3"
if VENV_PYTHON.exists() and sys.executable != str(VENV_PYTHON):
    # Re-run with venv Python
    os.execv(str(VENV_PYTHON), [str(VENV_PYTHON)] + sys.argv)

import click
from src.indexer import index_project


@click.command()
@click.argument("path", type=click.Path(exists=True), default=".")
@click.option("--force", is_flag=True, help="Force re-index all files")
def main(path: str, force: bool):
    """Index a codebase for semantic search."""
    project_path = Path(path).resolve()

    try:
        index_project(project_path, force=force)
    except KeyboardInterrupt:
        print("\n\n⚠️  Indexing cancelled")
        sys.exit(1)
    except Exception as e:
        print(f"\n❌ Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
